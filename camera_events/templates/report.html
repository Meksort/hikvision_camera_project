<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        input[type="text"],
        input[type="date"],
        input[type="datetime-local"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="datetime-local"]:focus {
            outline: none;
            border-color: #667eea;
        }
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        button {
            padding: 15px 40px;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 200px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ */
        .employee-selector {
            position: relative;
            width: 100%;
        }
        .employee-selector-button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .employee-selector-button:hover {
            border-color: #667eea;
        }
        .employee-selector-button.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .employee-selector-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 5px;
            background: #1a1a1a;
            border-radius: 5px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 1000;
            max-height: 500px;
            overflow-y: auto;
            display: none;
        }
        .employee-selector-dropdown.show {
            display: block;
        }
        .employee-selector-search {
            padding: 12px;
            border-bottom: 1px solid #333;
        }
        .employee-selector-search input {
            width: 100%;
            padding: 8px 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-size: 14px;
        }
        .employee-selector-search input:focus {
            outline: none;
            border-color: #667eea;
        }
        .employee-selector-tree {
            padding: 8px 0;
        }
        .tree-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: white;
            user-select: none;
        }
        .tree-item:hover {
            background: #2a2a2a;
        }
        .tree-item.selected {
            background: #3a3a3a;
        }
        .tree-item-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }
        .tree-item-icon.expand {
            color: #ccc;
            font-size: 12px;
        }
        .tree-item-icon.checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #666;
            border-radius: 3px;
            background: transparent;
        }
        .tree-item-icon.checkbox.checked {
            background: #667eea;
            border-color: #667eea;
        }
        .tree-item-icon.checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        .tree-item-icon.folder {
            color: #888;
            font-size: 16px;
        }
        .tree-item-icon.user {
            color: #aaa;
            font-size: 16px;
        }
        .tree-item-text {
            flex: 1;
            font-size: 14px;
        }
        .tree-item-children {
            margin-left: 28px;
            display: none;
        }
        .tree-item-children.expanded {
            display: block;
        }
        .tree-item.delete-icon {
            width: 20px;
            height: 20px;
            margin-left: 8px;
            background: #d32f2f;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tree-item:hover .delete-icon {
            opacity: 1;
        }
        .selected-employee-info {
            margin-top: 10px;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤</h1>
        
        <form id="reportForm">
            <div class="form-group">
                <label>
                    <input type="radio" name="report_type" value="employee" id="report_type_employee" checked onchange="toggleReportType()">
                    –û—Ç—á–µ—Ç –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É
                </label>
                <label style="margin-left: 20px;">
                    <input type="radio" name="report_type" value="attendance" id="report_type_attendance" onchange="toggleReportType()">
                    –û—Ç—á–µ—Ç –ø–æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ (–ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º)
                </label>
            </div>
            
            <div id="employee_report_section">
                <div class="form-group">
                    <label for="employee_selector">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:</label>
                    <div class="employee-selector">
                        <button type="button" class="employee-selector-button" id="employeeSelectorButton">
                            <span id="selectedEmployeeText">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</span>
                            <span>‚ñº</span>
                        </button>
                        <div class="employee-selector-dropdown" id="employeeSelectorDropdown">
                            <div class="employee-selector-search">
                                <input type="text" id="employeeSearch" placeholder="–ü–æ–∏—Å–∫...">
                            </div>
                            <div class="employee-selector-tree" id="employeeTree"></div>
                        </div>
                    </div>
                    <div class="selected-employee-info" id="selectedEmployeeInfo" style="display: none;">
                        <strong>–í—ã–±—Ä–∞–Ω:</strong> <span id="selectedEmployeeName"></span> 
                        (<span id="selectedEmployeeId"></span>)
                    </div>
                </div>
            </div>
            
            <div id="attendance_report_section" style="display: none;">
                <div class="form-group">
                    <label for="department_selector">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è:</label>
                    <div class="employee-selector">
                        <button type="button" class="employee-selector-button" id="departmentSelectorButton">
                            <span id="selectedDepartmentsText">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</span>
                            <span>‚ñº</span>
                        </button>
                    <div class="employee-selector-dropdown" id="departmentSelectorDropdown">
                        <div class="employee-selector-search">
                            <input type="text" id="departmentSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π...">
                        </div>
                        <div class="employee-selector-tree" id="departmentTree"></div>
                    </div>
                    </div>
                    <div class="selected-employee-info" id="selectedDepartmentsInfo" style="display: none;">
                        <strong>–í—ã–±—Ä–∞–Ω–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π:</strong> <span id="selectedDepartmentsCount">0</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="start_date">–° –∫–∞–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏:</label>
                <input type="datetime-local" id="start_date" name="start_date">
            </div>
            
            <div class="form-group">
                <label for="end_date">–ü–æ –∫–∞–∫–æ–µ –≤—Ä–µ–º—è:</label>
                <input type="datetime-local" id="end_date" name="end_date">
            </div>
            
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="exportReport()">
                    üìä –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç
                </button>
            </div>
        </form>
    </div>
    
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let departmentsData = [];
        let selectedEmployee = null;
        let selectedDepartments = [];
        let filteredTree = null;
        let autoUpdateInterval = null;
        let lastUpdateTime = null;

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (—Å–µ–≥–æ–¥–Ω—è)
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        document.getElementById('start_date').value = formatDateTimeLocal(today);
        document.getElementById('end_date').value = formatDateTimeLocal(tomorrow);
        
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–¥–µ–ª–æ–≤ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
        async function loadDepartments() {
            try {
                const response = await fetch('/api/v1/departments/');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                departmentsData = await response.json();
                renderTree(departmentsData);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–¥–µ–ª–æ–≤:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            }
        }

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –≤—Å–µ—Ö –æ—Ç–¥–µ–ª–æ–≤ –≤ –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
        function getAllEmployees(departments) {
            let allEmployees = [];
            
            function collectEmployees(dept) {
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–¥–µ–ª–∞
                if (dept.employees && dept.employees.length > 0) {
                    allEmployees = allEmployees.concat(dept.employees);
                }
                // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ –æ—Ç–¥–µ–ª—ã
                if (dept.children && dept.children.length > 0) {
                    dept.children.forEach(child => collectEmployees(child));
                }
            }
            
            departments.forEach(dept => collectEmployees(dept));
            return allEmployees;
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–±–µ–∑ –æ—Ç–¥–µ–ª–æ–≤)
        function renderTree(departments, searchTerm = '') {
            const treeContainer = document.getElementById('employeeTree');
            treeContainer.innerHTML = '';
            
            if (!departments || departments.length === 0) {
                treeContainer.innerHTML = '<div class="tree-item" style="color: #888; padding: 20px; text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏–∑ –≤—Å–µ—Ö –æ—Ç–¥–µ–ª–æ–≤
            let allEmployees = getAllEmployees(departments);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
            if (searchTerm) {
                allEmployees = allEmployees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm) ||
                    emp.hikvision_id.toLowerCase().includes(searchTerm)
                );
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∏–º–µ–Ω–∏
            allEmployees.sort((a, b) => a.name.localeCompare(b.name));
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            if (allEmployees.length === 0) {
                treeContainer.innerHTML = '<div class="tree-item" style="color: #888; padding: 20px; text-align: center;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            allEmployees.forEach(employee => {
                const employeeItem = createEmployeeItem(employee, searchTerm);
                treeContainer.appendChild(employeeItem);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function createEmployeeItem(employee, searchTerm = '') {
            const item = document.createElement('div');
            item.className = 'tree-item';
            item.dataset.type = 'employee';
            item.dataset.id = employee.id;
            item.dataset.hikvisionId = employee.hikvision_id;
            item.dataset.name = employee.name;
            
            const isSelected = selectedEmployee && selectedEmployee.hikvision_id === employee.hikvision_id;
            
            item.innerHTML = `
                <div class="tree-item-icon checkbox ${isSelected ? 'checked' : ''}"></div>
                <div class="tree-item-icon user">üë§</div>
                <div class="tree-item-text">${highlightSearch(employee.name, searchTerm)}</div>
            `;
            
            if (isSelected) {
                item.classList.add('selected');
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                selectEmployee(employee);
            });
            
            return item;
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        function highlightSearch(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
        function toggleExpand(icon) {
            const item = icon.closest('.tree-item');
            const children = item.querySelector('.tree-item-children');
            if (children) {
                const isExpanded = children.classList.contains('expanded');
                children.classList.toggle('expanded');
                icon.classList.toggle('expanded');
                icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
            }
        }

        // –í—ã–±–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function selectEmployee(employee) {
            selectedEmployee = employee;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('selectedEmployeeText').textContent = employee.name;
            document.getElementById('employeeSelectorButton').classList.add('selected');
            document.getElementById('selectedEmployeeInfo').style.display = 'block';
            document.getElementById('selectedEmployeeName').textContent = employee.name;
            document.getElementById('selectedEmployeeId').textContent = employee.hikvision_id;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —á–µ–∫–±–æ–∫—Å—ã –≤ –¥–µ—Ä–µ–≤–µ
            document.querySelectorAll('.tree-item[data-type="employee"]').forEach(item => {
                const checkbox = item.querySelector('.checkbox');
                if (item.dataset.hikvisionId === employee.hikvision_id) {
                    checkbox.classList.add('checked');
                    item.classList.add('selected');
                } else {
                    checkbox.classList.remove('checked');
                    item.classList.remove('selected');
                }
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown
            document.getElementById('employeeSelectorDropdown').classList.remove('show');
        }

        // –ü–æ–∏—Å–∫
        document.getElementById('employeeSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            renderTree(departmentsData, searchTerm);
        });

        // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ dropdown
        document.getElementById('employeeSelectorButton').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('employeeSelectorDropdown');
            dropdown.classList.toggle('show');
            
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (dropdown.classList.contains('show') && departmentsData.length === 0) {
                loadDepartments();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', (e) => {
            const selector = document.querySelector('.employee-selector');
            if (!selector.contains(e.target)) {
                document.getElementById('employeeSelectorDropdown').classList.remove('show');
            }
        });


        function getQueryParams() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            const params = new URLSearchParams();
            if (selectedEmployee && selectedEmployee.hikvision_id) {
                params.append('hikvision_id', selectedEmployee.hikvision_id);
            }
            if (startDate) {
                const startDateStr = startDate.replace('T', ' ') + ':00';
                params.append('start_date', startDateStr);
            }
            if (endDate) {
                const endDateStr = endDate.replace('T', ' ') + ':00';
                params.append('end_date', endDateStr);
            }
            
            return params.toString();
        }
        
        function toggleReportType() {
            const reportType = document.querySelector('input[name="report_type"]:checked').value;
            const employeeSection = document.getElementById('employee_report_section');
            const attendanceSection = document.getElementById('attendance_report_section');
            
            if (reportType === 'employee') {
                employeeSection.style.display = 'block';
                attendanceSection.style.display = 'none';
            } else {
                employeeSection.style.display = 'none';
                attendanceSection.style.display = 'block';
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (departmentsData.length === 0) {
                    loadDepartments().then(() => {
                        renderDepartmentTree();
                    });
                } else {
                    renderDepartmentTree();
                }
            }
        }
        
        function exportReport() {
            const reportType = document.querySelector('input[name="report_type"]:checked').value;
            
            if (reportType === 'employee') {
                if (!selectedEmployee) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
                    return;
                }
                const params = getQueryParams();
                const url = `/api/v1/camera-events/export-excel/${params ? '?' + params : ''}`;
                window.location.href = url;
            } else {
                // –û—Ç—á–µ—Ç –ø–æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
                if (selectedDepartments.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ');
                    return;
                }
                const params = getAttendanceParams();
                const url = `/api/v1/attendance-stats/export-excel/${params ? '?' + params : ''}`;
                window.location.href = url;
            }
        }
        
        function getAttendanceParams() {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            const params = new URLSearchParams();
            
            // –î–æ–±–∞–≤–ª—è–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
            selectedDepartments.forEach(deptId => {
                params.append('department_id', deptId);
            });
            
            if (startDate) {
                const startDateStr = startDate.split('T')[0]; // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É
                params.append('start_date', startDateStr);
            }
            if (endDate) {
                const endDateStr = endDate.split('T')[0]; // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É
                params.append('end_date', endDateStr);
            }
            
            return params.toString();
        }
        
        function exportCameraEvents() {
            if (!selectedEmployee) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞');
                return;
            }
            const params = getQueryParams();
            const url = `/api/v1/camera-events/export-excel/${params ? '?' + params : ''}`;
            window.location.href = url;
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º–∏
        function renderDepartmentTree(searchTerm = '') {
            const treeContainer = document.getElementById('departmentTree');
            treeContainer.innerHTML = '';
            
            if (!departmentsData || departmentsData.length === 0) {
                treeContainer.innerHTML = '<div class="tree-item" style="color: #888; padding: 20px; text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
                return;
            }
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –ê–£–ü/ –∏ –ù–ï –ê–£–ü/
            const aupDepartments = [];
            const notAupDepartments = [];
            
            function collectDepartments(dept, parentPath = '') {
                const deptName = dept.name || '';
                const fullPath = parentPath ? `${parentPath}/${deptName}` : deptName;
                const isAup = fullPath.startsWith('–ê–£–ü/') || fullPath.startsWith('–ê–£–ü');
                const isNotAup = fullPath.startsWith('–ù–ï –ê–£–ü/') || fullPath.startsWith('–ù–ï –ê–£–ü');
                
                const deptInfo = {
                    id: dept.id,
                    name: deptName,
                    fullPath: fullPath,
                    children: []
                };
                
                // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–æ—á–µ—Ä–Ω–∏–µ –æ—Ç–¥–µ–ª—ã
                if (dept.children && dept.children.length > 0) {
                    dept.children.forEach(child => {
                        const childInfo = collectDepartments(child, fullPath);
                        if (childInfo) {
                            deptInfo.children.push(childInfo);
                        }
                    });
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                // –í –ù–ï –ê–£–ü/ –ø–æ–ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å "–ù–ï –ê–£–ü/"
                if (isAup) {
                    aupDepartments.push(deptInfo);
                } else if (isNotAup) {
                    notAupDepartments.push(deptInfo);
                }
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–µ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∏–∫—É–¥–∞
                
                return deptInfo;
            }
            
            departmentsData.forEach(dept => collectDepartments(dept));
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
            function filterDepartments(depts, searchTerm) {
                if (!searchTerm) return depts;
                const filtered = [];
                depts.forEach(dept => {
                    const matches = dept.fullPath.toLowerCase().includes(searchTerm.toLowerCase());
                    const childrenMatch = filterDepartments(dept.children, searchTerm);
                    if (matches || childrenMatch.length > 0) {
                        filtered.push({
                            ...dept,
                            children: childrenMatch
                        });
                    }
                });
                return filtered;
            }
            
            const filteredAup = filterDepartments(aupDepartments, searchTerm);
            const filteredNotAup = filterDepartments(notAupDepartments, searchTerm);
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ê–£–ü/
            if (filteredAup.length > 0) {
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'tree-item';
                categoryHeader.style.fontWeight = 'bold';
                categoryHeader.style.backgroundColor = '#2a2a2a';
                categoryHeader.innerHTML = `
                    <div class="tree-item-icon folder">üìÅ</div>
                    <div class="tree-item-text">–ê–£–ü/</div>
                `;
                treeContainer.appendChild(categoryHeader);
                
                filteredAup.forEach(dept => {
                    renderDeptItem(dept, treeContainer, 1, searchTerm);
                });
            }
            
            // –†–µ–Ω–¥–µ—Ä–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ù–ï –ê–£–ü/
            if (filteredNotAup.length > 0) {
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'tree-item';
                categoryHeader.style.fontWeight = 'bold';
                categoryHeader.style.backgroundColor = '#2a2a2a';
                categoryHeader.innerHTML = `
                    <div class="tree-item-icon folder">üìÅ</div>
                    <div class="tree-item-text">–ù–ï –ê–£–ü/</div>
                `;
                treeContainer.appendChild(categoryHeader);
                
                filteredNotAup.forEach(dept => {
                    renderDeptItem(dept, treeContainer, 1, searchTerm);
                });
            }
            
            if (treeContainer.children.length === 0) {
                treeContainer.innerHTML = '<div class="tree-item" style="color: #888; padding: 20px; text-align: center;">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }
        }
        
        function renderDeptItem(dept, container, level = 0, searchTerm = '') {
            const item = document.createElement('div');
            item.className = 'tree-item';
            item.dataset.type = 'department';
            item.dataset.id = dept.id;
            item.style.paddingLeft = `${level * 20 + 12}px`;
            
            const isSelected = selectedDepartments.includes(dept.id.toString());
            
            item.innerHTML = `
                <div class="tree-item-icon checkbox ${isSelected ? 'checked' : ''}"></div>
                <div class="tree-item-icon folder">üìÅ</div>
                <div class="tree-item-text">${highlightSearch(dept.fullPath, searchTerm)}</div>
            `;
            
            if (isSelected) {
                item.classList.add('selected');
            }
            
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDepartment(dept.id, dept.fullPath);
            });
            
            container.appendChild(item);
            
            // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –¥–æ—á–µ—Ä–Ω–∏–µ –æ—Ç–¥–µ–ª—ã
            if (dept.children && dept.children.length > 0) {
                dept.children.forEach(child => {
                    renderDeptItem(child, container, level + 1, searchTerm);
                });
            }
        }
        
        function toggleDepartment(deptId, deptName) {
            const deptIdStr = deptId.toString();
            const index = selectedDepartments.indexOf(deptIdStr);
            if (index > -1) {
                selectedDepartments.splice(index, 1);
            } else {
                selectedDepartments.push(deptIdStr);
            }
            
            updateDepartmentSelectorUI();
            renderDepartmentTree();
        }
        
        function updateDepartmentSelectorUI() {
            const count = selectedDepartments.length;
            document.getElementById('selectedDepartmentsCount').textContent = count;
            
            if (count > 0) {
                document.getElementById('selectedDepartmentsText').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${count} –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π`;
                document.getElementById('departmentSelectorButton').classList.add('selected');
                document.getElementById('selectedDepartmentsInfo').style.display = 'block';
            } else {
                document.getElementById('selectedDepartmentsText').textContent = '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π';
                document.getElementById('departmentSelectorButton').classList.remove('selected');
                document.getElementById('selectedDepartmentsInfo').style.display = 'none';
            }
        }
        
        // –ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è–º
        document.getElementById('departmentSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();
            renderDepartmentTree(searchTerm);
        });

        // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ dropdown –¥–ª—è –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π
        document.getElementById('departmentSelectorButton').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('departmentSelectorDropdown');
            dropdown.classList.toggle('show');
            
            if (dropdown.classList.contains('show')) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: –ê–£–ü/ –∏ –ù–ï –ê–£–ü/
                const searchTerm = document.getElementById('departmentSearch').value.trim();
                renderDepartmentTree(searchTerm);
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        async function autoUpdateData() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API (–±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π)
                const response = await fetch('/api/v1/entries-exits/?ordering=-created_at');
                if (!response.ok) return;
                
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                    const latestRecord = data.results[0];
                    const latestTime = new Date(latestRecord.created_at || latestRecord.entry_time || latestRecord.updated_at);
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    if (!lastUpdateTime || latestTime > lastUpdateTime) {
                        lastUpdateTime = latestTime;
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–¥–µ–ª–æ–≤ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                        const response = await fetch('/api/v1/departments/');
                        if (response.ok) {
                            departmentsData = await response.json();
                            
                            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç dropdown —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                            const employeeDropdown = document.getElementById('employeeSelectorDropdown');
                            if (employeeDropdown.classList.contains('show')) {
                                const searchTerm = document.getElementById('employeeSearch').value.toLowerCase().trim();
                                renderTree(departmentsData, searchTerm);
                            }
                            
                            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç dropdown –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
                            const deptDropdown = document.getElementById('departmentSelectorDropdown');
                            if (deptDropdown.classList.contains('show')) {
                                const searchTerm = document.getElementById('departmentSearch').value.trim();
                                renderDepartmentTree(searchTerm);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', error);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        function startAutoUpdate() {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
            autoUpdateInterval = setInterval(autoUpdateData, 5000); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        }

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
        });

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadDepartments().then(() => {
            startAutoUpdate();
        });
    </script>
</body>
</html>
