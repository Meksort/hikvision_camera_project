# Описание всех файлов проекта Hikvision Camera

## Основные файлы проекта

### `manage.py`
- **Назначение**: Точка входа Django для выполнения административных команд
- **Функции**: Запускает Django команды (migrate, runserver, createsuperuser и т.д.)

### `requirements.txt`
- **Назначение**: Список зависимостей Python проекта
- **Содержит**: Django, djangorestframework, openpyxl, psycopg2-binary, python-dotenv

### `README.txt`
- **Назначение**: Краткая инструкция по быстрому старту проекта
- **Содержит**: Инструкции по запуску в Docker и локально, адреса доступа, API endpoints

---

## Конфигурация Docker

### `docker-compose.yml`
- **Назначение**: Конфигурация Docker Compose для запуска проекта в контейнерах
- **Содержит**: 
  - Конфигурацию веб-сервера (Django)
  - Настройки PostgreSQL (закомментирована, используется локальная БД)
  - Переменные окружения
  - Настройки сети и портов

### `Dockerfile`
- **Назначение**: Многоэтапная сборка Docker образа для Django приложения
- **Функции**: 
  - Устанавливает зависимости Python
  - Копирует код приложения
  - Настраивает права доступа
  - Создает non-root пользователя для безопасности

### `docker-entrypoint.sh`
- **Назначение**: Скрипт инициализации контейнера при запуске
- **Функции**: 
  - Ожидает готовности базы данных
  - Выполняет миграции
  - Собирает статические файлы
  - Создает суперпользователя (admin/admin123) если его нет

### `env.example`
- **Назначение**: Пример файла с переменными окружения
- **Содержит**: Шаблон настроек БД, Django SECRET_KEY, DEBUG, ALLOWED_HOSTS

---

## Основной проект Django

### `hikvision_project/settings.py`
- **Назначение**: Главный файл настроек Django проекта
- **Содержит**: 
  - Настройки базы данных (PostgreSQL)
  - Конфигурацию приложений
  - Настройки REST Framework
  - Логирование
  - Часовой пояс (Asia/Almaty)

### `hikvision_project/urls.py`
- **Назначение**: Главный файл маршрутизации URL
- **Содержит**: 
  - Маршруты для админки (/admin/)
  - API маршруты (/api/v1/)
  - Маршруты для отчетов (/report/, /excel/)

### `hikvision_project/wsgi.py`
- **Назначение**: WSGI конфигурация для развертывания на продакшн сервере

---

## Приложение camera_events

### Модели данных

#### `camera_events/models.py`
- **Назначение**: Определяет все модели данных проекта
- **Модели**:
  - `Department` - Подразделения с поддержкой иерархии
  - `CameraEvent` - Сырые события от камер Hikvision
  - `Employee` - Сотрудники с привязкой к подразделениям
  - `EntryExit` - Записи входов и выходов сотрудников
  - `WorkSchedule` - Графики работы (обычные, плавающие, круглосуточные)
  - `EmployeeAttendanceStats` - Статистика опозданий и ранних уходов
  - `AttendanceRecord` - Записи посещаемости с анализом аномалий

### Обработка данных

#### `camera_events/event_processor.py`
- **Назначение**: Обрабатывает события от камер в реальном времени
- **Функции**: 
  - Определяет тип события (вход/выход) по IP адресу камеры
  - Создает/обновляет записи EntryExit автоматически
  - Обрабатывает ночные смены

#### `camera_events/signals.py`
- **Назначение**: Django сигналы для автоматической обработки событий
- **Функции**: При сохранении нового CameraEvent автоматически вызывает обработчик

#### `camera_events/schedule_matcher.py`
- **Назначение**: Сопоставляет записи входов/выходов с графиками работы
- **Функции**: 
  - Определяет опоздания и ранние уходы
  - Обрабатывает разные типы графиков (обычные, плавающие, круглосуточные)
  - Учитывает допустимые отклонения от графика

#### `camera_events/schedule_processor.py`
- **Назначение**: УСТАРЕВШИЙ модуль (не используется)
- **Примечание**: Логика перенесена в schedule_matcher.py

### API и представления

#### `camera_events/views.py`
- **Назначение**: Основной файл с ViewSet'ами и функциями для API
- **Содержит**: 
  - `CameraEventViewSet` - API для работы с событиями камер
  - `EntryExitViewSet` - API для записей входов/выходов
  - `AttendanceStatsViewSet` - API для статистики посещаемости
  - Функции генерации отчетов в Excel
  - Функция пересчета EntryExit из CameraEvent

#### `camera_events/viewsets/department.py`
- **Назначение**: ViewSet для работы с подразделениями
- **Функции**: Возвращает иерархическую структуру отделов с сотрудниками

#### `camera_events/urls.py`
- **Назначение**: Маршруты API для приложения camera_events
- **Содержит**: Регистрацию всех ViewSet'ов через Django REST Framework router

#### `camera_events/serializers.py`
- **Назначение**: Сериализаторы для преобразования моделей в JSON
- **Содержит**: 
  - `CameraEventSerializer` - для событий камер
  - `EntryExitSerializer` - для записей входов/выходов
  - `DepartmentSerializer` - для подразделений с иерархией
  - `EmployeeSimpleSerializer` - упрощенный сериализатор сотрудников

### Администрирование

#### `camera_events/admin.py`
- **Назначение**: Настройка Django админки
- **Содержит**: 
  - Регистрацию всех моделей в админке
  - Кастомные отображения полей
  - Фильтры и поиск

#### `camera_events/apps.py`
- **Назначение**: Конфигурация приложения
- **Функции**: Подключает сигналы при запуске приложения

### Генерация отчетов

#### `camera_events/python_reports.py`
- **Назначение**: Генерация отчетов о посещаемости используя Python/Django ORM
- **Функции**: 
  - `generate_comprehensive_attendance_report_python()` - комплексный отчет
  - Обработка всех типов графиков
  - Расчет опозданий и ранних уходов

#### `camera_events/sql_reports.py`
- **Назначение**: Оптимизированные SQL запросы для генерации отчетов
- **Функции**: 
  - `generate_attendance_report_sql()` - базовый SQL отчет
  - `generate_round_the_clock_report_sql()` - отчет для круглосуточных графиков
  - `generate_comprehensive_attendance_report_sql()` - комплексный SQL отчет

### Утилиты

#### `camera_events/utils.py`
- **Назначение**: Вспомогательные функции и константы
- **Содержит**: 
  - `clean_id()` - удаление ведущих нулей из ID
  - `ensure_aware()` - конвертация datetime в timezone-aware
  - `get_excluded_hikvision_ids()` - список исключаемых сотрудников
  - Константы для дней недели и типов графиков

#### `camera_events/import_employees.py`
- **Назначение**: Импорт и экспорт сотрудников из/в Excel файлы
- **Функции**: 
  - `import_employees_from_excel()` - импорт сотрудников с графиками
  - `export_employees_to_excel()` - экспорт сотрудников в Excel
  - Поддержка иерархии подразделений
  - Обработка графиков работы

### Шаблоны

#### `camera_events/templates/report.html`
- **Назначение**: HTML шаблон для страницы отчетов

#### `camera_events/templates/excel.html`
- **Назначение**: HTML шаблон для страницы экспорта в Excel

---

## Скрипты для работы с данными

### `recalculate_attendance_stats.py`
- **Назначение**: Пересчет статистики посещаемости (опоздания, ранние уходы)
- **Функции**: 
  - Обнуляет и пересчитывает статистику с указанной даты
  - Учитывает графики работы сотрудников
  - Исключает определенные категории сотрудников
  - Обновляет флаги учета в EntryExit

### `recalculate_entries_exits.py`
- **Назначение**: Пересчет записей EntryExit из CameraEvent
- **Функции**: 
  - Обрабатывает события камер за указанный период
  - Определяет входы/выходы по IP адресам камер
  - Создает/обновляет записи EntryExit

### `export_employees.py`
- **Назначение**: Экспорт сотрудников в Excel файл
- **Функции**: 
  - Экспортирует сотрудников из базы данных
  - Включает сотрудников из событий камер
  - Поддерживает фильтрацию по подразделениям

### `import_employees.py`
- **Назначение**: Импорт сотрудников из Excel файла
- **Примечание**: Использует функции из `camera_events/import_employees.py`

### `populate_departments.py`
- **Назначение**: Создание структуры подразделений организации
- **Функции**: 
  - Создает иерархическую структуру отделов
  - Рекурсивно создает подразделения с родителями

### `create_departments_from_old.py`
- **Назначение**: Миграция подразделений из старого поля `department_old`
- **Функции**: 
  - Создает отделы из уникальных значений `department_old`
  - Привязывает сотрудников к новым отделам

### `check_december_22.py`
- **Назначение**: Проверка данных за 22 декабря
- **Примечание**: Специфичный скрипт для проверки данных

### `check_december_20_21.py`
- **Назначение**: Проверка данных за 20-21 декабря
- **Примечание**: Специфичный скрипт для проверки данных

### `check_employee_dec_20_21.py`
- **Назначение**: Проверка данных сотрудников за 20-21 декабря
- **Примечание**: Специфичный скрипт для проверки данных

---

## Batch скрипты (Windows)

### `docker-start.bat`
- **Назначение**: Запуск проекта в Docker
- **Функции**: 
  - Проверяет наличие Docker
  - Собирает и запускает контейнеры
  - Выводит адреса доступа

### `docker-stop.bat`
- **Назначение**: Остановка Docker контейнеров

### `start.bat`
- **Назначение**: Локальный запуск Django сервера
- **Функции**: 
  - Проверяет виртуальное окружение
  - Проверяет подключение к БД
  - Запускает сервер на 0.0.0.0:8000

### `migrate.bat`
- **Назначение**: Выполнение миграций базы данных

### `makemigrations.bat`
- **Назначение**: Создание новых миграций

### `recalculate_attendance_stats.bat`
- **Назначение**: Запуск пересчета статистики посещаемости

### `recalculate_entries_exits.bat`
- **Назначение**: Запуск пересчета записей EntryExit

### `recalculate_entries_exits_2025_2030.bat`
- **Назначение**: Пересчет записей за период 2025-2030
- **Примечание**: Специфичный скрипт для определенного периода

### `backup_database.bat`
- **Назначение**: Резервное копирование базы данных

### `restore_database.bat`
- **Назначение**: Восстановление базы данных из резервной копии

### `check_dec_20_21.bat`
- **Назначение**: Запуск проверки данных за 20-21 декабря

---

## Документация

### `DOCKER_SETUP.md`
- **Назначение**: Подробная инструкция по настройке и запуску в Docker

### `SETUP_LOCAL_DB.md`
- **Назначение**: Инструкция по настройке локальной базы данных PostgreSQL

### `QUICK_START_DOCKER.md`
- **Назначение**: Быстрый старт проекта в Docker

### `QUICK_MIGRATION_GUIDE.md`
- **Назначение**: Краткое руководство по миграции данных

### `MIGRATE_DATABASE_TO_ANOTHER_PC.md`
- **Назначение**: Инструкция по переносу базы данных на другой компьютер

### `MIGRATE_DB_TO_DOCKER.md`
- **Назначение**: Инструкция по миграции БД в Docker

### `DATABASE_LOCATION.md`
- **Назначение**: Информация о расположении базы данных

### `FIND_DATABASE_LOCATION.md`
- **Назначение**: Как найти расположение базы данных PostgreSQL

### `NETWORK_ACCESS.md`
- **Назначение**: Настройка доступа к серверу из локальной сети

### `MANUAL_RECALCULATE.md`
- **Назначение**: Инструкция по ручному пересчету статистики

### `CHECK_DECEMBER_22.md`
- **Назначение**: Документация по проверке данных за 22 декабря

### `CHECK_DECEMBER_20_21.md`
- **Назначение**: Документация по проверке данных за 20-21 декабря

---

## Файлы данных

### `employee_import_template.xlsx`
- **Назначение**: Шаблон Excel файла для импорта сотрудников

### `employees_export.xlsx`
- **Назначение**: Экспортированные данные сотрудников (результат работы скрипта)

---

## Миграции базы данных

### `camera_events/migrations/`
- **Назначение**: Файлы миграций Django для изменения структуры БД
- **Содержит**: 
  - `0001_initial.py` - начальная миграция
  - `0002_*` - удаление индексов
  - `0003_entryexit.py` - создание модели EntryExit
  - `0004_employee.py` - создание модели Employee
  - `0005_department_and_update_employee.py` - добавление подразделений
  - `0006_*` - переименование индексов
  - `0007_workschedule.py` - создание модели WorkSchedule
  - `0008_*` - добавление флагов учета статистики
  - `0009_add_position_field.py` - добавление поля должности
  - `0010_attendancerecord.py` - создание модели AttendanceRecord

---

## Структура проекта

Проект представляет собой Django приложение для:
1. **Приема событий** от камер Hikvision через API
2. **Обработки событий** и создания записей входов/выходов
3. **Управления сотрудниками** и подразделениями
4. **Учета графиков работы** (обычные, плавающие, круглосуточные)
5. **Генерации отчетов** о посещаемости с анализом опозданий и ранних уходов
6. **Экспорта данных** в Excel формат

Все файлы работают вместе для создания системы учета рабочего времени на основе событий от камер контроля доступа.

